@{
    ViewData["Title"] = "Camera Capture";
    var username = ViewBag.User ?? "Guest";
}

<div class="d-flex justify-content-center align-items-center vh-100 bg-light">
    <div class="card shadow-lg p-4 text-center" style="width: 100%; max-width: 500px;">
        <h3 class="fw-bold mb-3">Hello, @username 👋</h3>
        <p class="text-muted">We are capturing your photo...</p>

        <video id="video" autoplay playsinline width="100%" height="auto" class="rounded mb-3"></video>
        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    </div>
</div>

<script>
    const username = "@username";

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.getElementById("video");
            video.srcObject = stream;

            // Auto capture after 2 seconds
            setTimeout(() => {
                capturePhoto(video, stream);
            }, 2000);

        } catch (err) {
            alert("Camera access denied: " + err);
            window.location.href = "/Home/Index";
        }
    }

    function capturePhoto(video, stream) {
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL("image/png"); // base64 image

        // Save to localStorage
        localStorage.setItem("photo_" + username, imageData);
        localStorage.setItem("user", username);

        // stop camera
        stream.getTracks().forEach(track => track.stop());

        // redirect to home
        window.location.href = "/Home/Index";
    }

    startCamera();
</script>
